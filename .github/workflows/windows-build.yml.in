name: Build Windows Release

on:
  push:
    branches: [ main ]  # Or your release branch
  workflow_dispatch:  # Enables manual trigger from GitHub UI

env:
  PACKAGE_NAME: NIC-Stats
  PACKAGE_VERSION: @PROJECT_VERSION@
  BUILD_DIR: ${{github.WORKSPACE}}/build

jobs:
  build-windows:
    runs-on: windows-2022
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '@Qt6Core_VERSION@'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2022_64'

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Configure CMake
      run: cmake -S ${{github.WORKSPACE}} -B ${{env.BUILD_DIR}} -G Ninja -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build ${{env.BUILD_DIR}} --target all package

    - name: Release
      # if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        name: NIC Stats ${{env.PACKAGE_VERSION}} released ðŸŽ‰
        body_path: ${{github.WORKSPACE}}/notes/RELEASE-${{env.PACKAGE_VERSION}}.txt
        tag_name: v${{env.PACKAGE_VERSION}}
        files: |
          ${{env.BUILD_DIR}}/*.zip
        make_latest: true

name: Build Windows Release

on:
  push:
    branches: [ main ]  # Or your release branch
  workflow_dispatch:  # Enables manual trigger from GitHub UI

env:
  PACKAGE_NAME: NIC-Stats
  PACKAGE_VERSION: 1.1
  BUILD_DIR: ${{github.workspace}}/build

jobs:
  build-windows:
    runs-on: windows-2022
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2022_64'

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Configure CMake
      run: cmake -S ${{github.workspace}} -B ${{env.BUILD_DIR}} -G Ninja -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build ${{env.BUILD_DIR}} --target all package

    - name: Release
      # if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        name: NIC Stats ${{env.PACKAGE_VERSION}} released ðŸŽ‰
        body_path: ${{github.workspace}}/notes/RELEASE-${{env.PACKAGE_VERSION}}.txt
        tag_name: v${{env.PACKAGE_VERSION}}
        files: |
          ${{env.BUILD_DIR}}/*.zip
        make_latest: true

    - name: Send Mails
      uses: dawidd6/action-send-mail@v3
      continue-on-error: true
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{secrets.MAIL_ADDRESS}}
        password: ${{secrets.MAIL_PASSWORD}}
        subject: NIC Stats ${{env.PACKAGE_VERSION}} released !
        to: amadoubenjamain@gmail.com,assakayecelestin@gmail.com
        from: Amadou Benjamain
        body: "Hello, a new version of NIC Stats has just been released, download and try !"
        attachments: ${{env.BUILD_DIR}}/*.zip

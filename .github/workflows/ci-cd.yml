name: CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Enables manual trigger from GitHub UI

env:
  PACKAGE_NAME: NIC-Stats
  PACKAGE_VERSION: 1.3
  BUILD_DIR: ${{github.workspace}}/build

jobs:
  build:
    strategy:
      matrix:
        include:
          - platform: Windows
            os: windows-2022
            host: windows
            arch: win64_msvc2022_64

          - platform: Linux
            os: ubuntu-latest
            host: linux
            arch: linux_gcc_64
    runs-on: ${{matrix.os}}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.0'
          host: ${{matrix.host}}
          target: ${{matrix.target}}
          arch: ${{matrix.arch}}

      - name: Setup MSVC
        if: ${{matrix.host}} == 'windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure CMake
        run: cmake -S ${{github.workspace}} -B ${{env.BUILD_DIR}} -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build ${{env.BUILD_DIR}} --target all package

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.platform}}-Build
          path: |
            ${{env.BUILD_DIR}}/*.zip
            ${{env.BUILD_DIR}}/*.tar.gz

  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create Release
        # if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          name: NIC Stats ${{env.PACKAGE_VERSION}}
          body_path: ${{github.workspace}}/notes/RELEASE-${{env.PACKAGE_VERSION}}.md
          tag_name: v${{env.PACKAGE_VERSION}}
          files: |
            *.*
          make_latest: true

      - name: Send Mails
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{secrets.MAIL_ADDRESS}}
          password: ${{secrets.MAIL_PASSWORD}}
          subject: NIC Stats ${{env.PACKAGE_VERSION}} released !
          to: amadoubenjamain@gmail.com,nassir.hamadou@gmail.com,assakayecelestin@gmail.com
          from: Amadou Benjamain
          body: "Hello, NIC Stats 1.3 has just been released, look at the new features !\n\n# NIC Stats 1.3 Released üéâ\n\nWe are excited to announce the release of NIC Stats 1.3! This version includes a key new feature designed to significantly improve your workflow when analyzing statistical data.\n\n## What's New\n\nColumn Locking Feature in Excel\nThis new feature adds column locking to the generated Excel statistics file. This enhancement makes navigating between individual data envelopes much easier and more efficient, saving you time and effort when reviewing your data.\n\n## What next ?\n\nPlan to add pdf file handling support (using iLovePDF API) and multi dispatch generation.\n\nMade with ‚ô•Ô∏è by Amadou Benjamain.\n\nDownload and try: https://github.com/commander15/NIC-Stats/releases/latest"

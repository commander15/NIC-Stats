name: CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Enables manual trigger from GitHub UI

env:
  PACKAGE_NAME: NIC-Stats
  PACKAGE_VERSION: 1.4
  BUILD_DIR: ${{github.workspace}}/build

jobs:
  build:
    strategy:
      matrix:
        include:
          - platform: Windows
            os: windows-2022
            host: windows
            arch: win64_msvc2019_64

          - platform: Linux
            os: ubuntu-latest
            host: linux
            arch: linux_gcc_64

    runs-on: ${{matrix.os}}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: ${{matrix.host}}
          target: ${{matrix.target}}
          arch: ${{matrix.arch}}
          modules: 'qtpdf'

      - name: Setup MSVC (Windows only)
        if: ${{matrix.host}} == 'windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure CMake
        run: cmake -S ${{github.workspace}} -B ${{env.BUILD_DIR}} -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build ${{env.BUILD_DIR}} --target all package --parallel 4

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.platform}}-Build
          path: |
            ${{env.BUILD_DIR}}/*.zip
            ${{env.BUILD_DIR}}/*.tar.gz

  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create Release
        # if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          name: NIC Stats ${{env.PACKAGE_VERSION}}
          body_path: ${{github.workspace}}/notes/RELEASE-${{env.PACKAGE_VERSION}}.md
          tag_name: v${{env.PACKAGE_VERSION}}
          files: *.*
          make_latest: true

      - name: Send Mails
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{secrets.MAIL_ADDRESS}}
          password: ${{secrets.MAIL_PASSWORD}}
          subject: NIC Stats ${{env.PACKAGE_VERSION}} released !
          to: amadoubenjamain@gmail.com,nassir.hamadou@gmail.com,assakayecelestin@gmail.com
          from: Amadou Benjamain
          body: "Hello, NIC Stats 1.4 has just been released, look at the new features !\n\n# NIC Stats 1.4 Released üöÄ\n\n## üìï **PDF support is here!**  \nNow drop PDFs directly ‚Äî no more ilovepdf suffering  \n\n**Experimental** ‚Äî test it, break it, tell me  \n\n*Also: faster processing + prettier Excel output*\n\nNext ‚Üí rock-solid PDFs + CLI mode  \n\nMade with coffee ‚òï, anime üßù & zero tolerance for manual work ‚ùå \nby Amadou Wanie Benjamin\n\nüí£ Go destroy those PDFs!\n\nDownload and try: https://github.com/commander15/NIC-Stats/releases/latest"
